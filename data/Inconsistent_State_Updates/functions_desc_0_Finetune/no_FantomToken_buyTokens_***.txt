Type of vulnerability: Unnecessary Complex Calculation Leading to Incorrect Staking Amounts
Cause of vulnerability: The calculation of excess tokens and remaining ETH is more complicated than necessary, leading to discrepancies that result in either the user not receiving their full requested amount or more ETH being transferred out than what the user should have received.
Explanation of vulnerability: The complexity of the calculation arises from attempting to determine the exact ETH amount to be returned to the user due to the token availability. However, this backandforth adjustment can be simplified to always require the full ETH amount for the tokens the user currently needs, which can be returned if the tokens become available later.
Impact of vulnerability: Users can be left without the full amount of tokens they requested, or the contract can overtransfer ETH to users due to a combination of rounding errors and the inefficient adjustment process.