Type of vulnerability: Margin Calculation Error
Cause of vulnerability: Incorrect computation of margin during the addition to a position, leading to less margin being pulled or burned than what was accounted for.
Execution process: When a user adds to a position, the function `addToPosition` calls `_handleDeposit` with the parameter `_addMargin - _fee`. The fee is calculated and minted as part of the margin, but this fee is subtracted from the margin before depositing, resulting in less margin being used than intended.
Vulnerable code: `_handleDeposit(_trade.tigAsset, _marginAsset, _addMargin - _fee, _stableVault, _permitData, _trader);`