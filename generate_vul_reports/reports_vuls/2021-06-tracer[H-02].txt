[H-02] Use of incorrect index leads to incorrect updation of funding rates
Submitted by 0xRajeev
TheupdateFundingRate()function updates the funding rate and insurance funding rate. While the instant/new funding rates are calculated correctly, the cumulative funding rate calculation is incorrect because it is always adding the instant to 0, not the previous value. This is due to the use of[currentFundingIndex]which has been updated since the previous call to this function while it should really be using[currentFundingIndex-1]to reference the previous funding rate.
The impact of this, is that the cumulative funding rate and insurance funding rates are calculated incorrectly without considering the correct previous values. This affects the settling of accounts across the entire protocol. The protocol logic is significantly impacted, accounts will not be settled as expected, protocol shutdown and contracts will need to be redeployed. Users may lose funds and the protocol takes a reputation hit.
Recommend using[currentFundingIndex-1]for non-zero values ofcurrentFundingIndexto get the value updated in the previous call on lines L155 and L159 ofPricing.sol.
raymogg (Tracer) confirmed:
Confirmed as an index issue with funding rate üëç