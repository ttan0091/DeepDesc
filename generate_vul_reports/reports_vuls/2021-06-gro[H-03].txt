[H-03] Incorrect use of operator leads to arbitrary minting of GVT tokens
Submitted by 0xRajeev, also found by pauliax and gpersoon
ThedistributeStrategyGainLoss()function distributes any gains or losses generated from a harvest and is expected to be called only by valid protocol vault adaptors. It is an externally visible function and the access control is indirectly enforced onmsg.senderby checking thatvaultIndexes[msg.sender]is a valid index range 1-4. However, the operator used in therequire()is||instead of&&, which allows an arbitrarymsg.sender, i.e. attacker, to bypass the check.
Scenario: An arbitrary non-vault address calling this function will get an index of 0 because of default mapping value invaultIndexes[msg.sender], which will fail the> 0check, but pass the<= N_COINS + 1check (N_COINS = 3) because0 <= 4which will allow control to go past this check.
Furthermore, on L362,index=0will underflow the -1 decrement (due to lack ofSafeMath.suband use of < 0.8.0 solc) and the index will be set to(uint256_MAX - 1). This will allow execution to proceed to the “else” part of conditional meant for curve LP vault. Therefore, this will allow any random address to call this function with arbitrary values of gain/loss and distribute arbitrary gain/loss appearing to come from Curve vault.
The attack control flow:
->Controller.distributeStrategyGainLoss(ARBITRARY_HIGH_VALUE_OF_GAIN, 0)->index = 0passes check for theindex <= N_COINS + 1part of predicate on L357 inController.sol->index = uint256_MAXafter L362->gainUsd = ibuoy.lpToUsd(ARBITRARY_HIGH_VALUE_OF_GAIN);on L371 inController.sol->ipnl.distributeStrategyGainLoss(gainUsd, lossUsd, reward);on L376 inController.sol->(gvtAssets, pwrdAssets, performanceBonus) = handleInvestGain(lastGA, lastPA, gain, reward);on L254 inPnL.sol->performanceBonus = profit.mul(performanceFee).div(PERCENTAGE_DECIMAL_FACTOR);on L186 ofPnL.sol->gvt.mint(reward, gvt.factor(gvtAssets), performanceBonus);on L256 inPnL.sol
Recommend changing||to&&inrequire()on L357 ofController.solto prevent arbitrary addresses from going past this check. Or, consider exercising explicit access control for the authorized vault adaptors.
kristian-gro (Gro) confirmed
Confirmed and Fix has been implemented in release version.