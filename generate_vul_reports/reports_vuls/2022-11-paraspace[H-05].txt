[H-05] Attacker can manipulate low TVL Uniswap V3 pool to borrow and swap to make Lending Pool in loss
Submitted byminhquanym
https://github.com/code-423n4/2022-11-paraspace/blob/c6820a279c64a299a783955749fdc977de8f0449/paraspace-core/contracts/misc/UniswapV3OracleWrapper.sol#L176
In Paraspace protocol, any Uniswap V3 position that are consist of ERC20 tokens that Paraspace support can be used as collateral to borrow funds from Paraspace pool. The value of the Uniswap V3 position will be sum of value of ERC20 tokens in it.
functiongetTokenPrice(uint256tokenId)publicviewreturns(uint256) {UinswapV3PositionDatamemorypositionData=getOnchainPositionData(tokenId);PairOracleDatamemoryoracleData=_getOracleData(positionData);(uint256liquidityAmount0,uint256liquidityAmount1) =LiquidityAmounts.getAmountsForLiquidity(oracleData.sqrtPriceX96,TickMath.getSqrtRatioAtTick(positionData.tickLower),TickMath.getSqrtRatioAtTick(positionData.tickUpper),positionData.liquidity);(uint256feeAmount0,uint256feeAmount1) =getLpFeeAmountFromPositionData(positionData);return// @audit can be easily manipulated with low TVL pool(((liquidityAmount0+feeAmount0) *oracleData.token0Price) /10**oracleData.token0Decimal) +(((liquidityAmount1+feeAmount1) *oracleData.token1Price) /10**oracleData.token1Decimal);}
However, Uniswap V3 can have multiple pools for thesame pairsof ERC20 tokens withdifferent feeparams. A fews has most the liquidity, while other pools have extremely little TVL or even not created yet. Attackers can abuse it, create low TVL pool where liquidity in this pool mostly (or fully) belong to attacker’s position, deposit this position as collateral and borrow token in Paraspace pool, swap to make the original position reduce the original value and cause Paraspace pool in loss.
Proof of Concept
Consider the scenario where WETH and DAI are supported as collateral in Paraspace protocol.
Alice (attacker) create a new WETH/DAI pool in Uniswap V3 and add liquidity with the following amount1e18 wei WETH - 1e6 wei DAI = 1 WETH - 1e-12 DAI ~= 1 ETHLet’s just assume Alice position has price range from[MIN_TICK, MAX_TICK]so the math can be approximately like Uniswap V2 - constant product.Note that this pool only has liquidity from Alice.Alice deposit this position into Paraspace, value of this position is approximately1 WETHand Alice borrow maximum possible amount of USDC.Alice make swap in her WETH/DAI pool in Uniswap V3 to make the position become1e6 wei WETH - 1e18 wei DAI = 1e-12 WETH - 1 DAI ~= 1 DAI
Please note that the math I’ve done above is approximation based on Uniswap V2 formulax * y = kbecause Alice provided liquidity fromMIN_TICKtoMAX_TICK.For more information about Uniswap V3 formula, please check their whitepaper here:https://uniswap.org/whitepaper-v3.pdf.
Recommended Mitigation Steps
Consider adding whitelist, only allowing pool with enough TVL to be collateral in Paraspace protocol.
LSDan (judge) commented:
Overinflated severity
minhquanym (warden) commented:
Hi @LSDan,
Maybe there is a misunderstanding here. I believed I gave enough proof to make it a High issue and protocol can be at loss.You can think of it as using Uniswap V3 pool as a price Oracle. However, it did not even use TWA price but spot price and pool with low liquidity is really easy to be manipulated. We all can see many examples about Price manipulation attacks recently and they had a common cause that price can be changed in one block.About the Uniswap V3 pool with low liquidity, you can check out this onehttps://etherscan.io/address/0xbb256c2F1B677e27118b0345FD2b3894D2E6D487.This is a USDC-USDT pool with only$8kin it.
LSDan (judge) commented:
This is not true because Alice’s pool will be immediately arbed each time she attempts a price manipulation. Accordingly, this issue only exists when a pair has very low liquidity on UniV3 and no liquidity elsewhere. I would have accepted this as a QA, but it does not fall into the realm of a high risk issue.I’m open to accepting this as a medium if you can give me a more concrete scenario where the value that Alice is extracting from the protocol through this attack is sustainable and significant enough to exceed the gas price of creating a new UniV3 pool.
minhquanym (warden) commented:
@LSDan, Please correct me if I’m wrong but I don’t think Alice’s pool can be arbed when the whole attack happens in 1 transaction. Because of that, I still believe that this is a High. For example,price before manipulation isp1flash loan and swap to change the price top2add liquidity and borrow at pricep2change the price back top1repay the flash loanThat’s basically the idea. You can see price is back top1at the end.
LSDan (judge) commented:
Ok yeah… I see what you’re saying now. This could be used to drain the pool because the underlying asset price comes from a different oracle. So if Alice creates a pool with 100 USDC and 100 USDT, and drops 3mm USDC from a flash loan into it, the external oracle will value the LP at$3mm. High makes sense. Thanks for the additional clarity.