[H-05] Flash loan price manipulation inpurchasePyroFlan()
Submitted by sirhashalot
The comment online 54of FlanBackstop.sol states “the opportunity for price manipulation through flash loans exists”, and I agree that this is a serious risk. While the acceptableHighestPrice variable attempts to limit the maximum price change of the flan-stablecoin LP, a flashloan sandwich attack can still occur within this limit and make up for the limitation with larger volumes or multiple flashloan attacks. Flashloan price manipulation is the cause for many major hacks, includingbZx,Harvest, and others.
Proof of Concept
Line 83of FlanBackstop.sol calculates the price of flan to stablecoin in the Uniswap pool based on the balances at a single point in time. Pool balances at a single point in time can be manipulated with flash loans, which can skew the numbers to the extreme. The single data point of LP balances is used to calculatethe growth variable in line 103, and the growth variable influences the quantity of pyroflan a user receives inthe premium calculation on line 108.
uint256priceBefore= (balanceOfFlanBefore*getMagnitude(stablecoin)) /balanceOfStableBefore;uint256growth= ((priceBefore-tiltedPrice) *100) /priceBefore;uint256premium= (flanToMint* (growth/2)) /100;
Problems can occur when the volumes that thepurchasePyroFlan()function sends to the Uniswap pool are large compared to the pool’s liquidity volume, or if the Uniswap pool price is temporarily tilted with a flashloan (or a whale). Because this function purposefully changes the exchange rate of the LP, by transferring tokens to the LP in a 2-to-1 ratio, a large volume could caught a large price impact in the LP. The code attempts to protect against this manipulation inline 102with a require statement, but this can be worked around by reducing the volume per flashloan and repeating the attack multiple times. A user can manipulate the LP, especially when the LP is new with low liquidity, in order to achieve large amounts of flan and pyroflan.
Recommended Mitigation Steps
Use a TWAP instead of the pool price at a single point in time to increase the cost of performing a flashloan sandwich attack. Seethe Uniswap v2 price oracle solutiondocumentation for more explanations on how Uniswap designed an approach to providing asset prices while reducing the change of manipulation.
gititGoro (Behodler) acknowledged and commented:
This is a very well constructed report and if Flan was not intended to target a 1:1 with stablecoins, I’d accept it but since we know Flan shouldn’t diverge far from 1:1, we don’t run very large risks. Essentially, if the flan price crashes dramatically, backstop no longer works so the purpose of this contract is to just boost liquidity for Flan when Flan is operating under normal ish conditions. It’s not intended to be black swan proof.