[H-01] Wrong trading pricing calculations
Submitted by 0xsanson, also found by shw
In thePricingcontract, an agent can manipulate the trading prices by spamming a high amount of trades.
Indeed an agent can create a high amount of orders at an arbitrary price and with a near-zero amount (so the agent doesn’t even need large funds); next he/she pairs the orders with another account and callsTrader.executeTrade; now every order calls aPricing.recordTradeusing the arbitrary price set by the agent.
Since the trades are all made in the same hour, by the wayhourlyTracerPrices[currentHour]is calculated, it skews the average price towards the price set by the agent. This arbitrary value is used to calculate thefundingRatesand thefairPrice, allowing a malicious agent the ability to manipulate the market.
Recommend passing thefillAmountparameter torecordTrade(...), and calculatehourlyTracerPrices[currentHour].tradessummingfillAmountinstead of 1 every trade.
raymogg (Tracer) confirmed:
Issue is valid, and there appear to be a few other issues that reference similar problems.The Trader contract will have a whitelist allowing only select relayers to push orders on chain. As long as off chain order books have sufficient liquidity, this issue is then mitigated as users can’t just arbitrarily match orders and send them in, they must be matched on a book with liquidity. To alter the price you would then need to eat through significant liquidity (increasing the cost of this attack).