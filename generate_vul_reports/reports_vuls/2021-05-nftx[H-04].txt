[H-04]NFTXLPStakingIs Subject To A Flash Loan Attack That Can Steal Nearly All Rewards/Fees That Have Accrued For A Particular Vault
The LPStaking contract does not require that a stake be locked for any period of time. The LPStaking contract also does not track how long your stake has been locked. So an attacker Alice can stake, claim rewards, and unstake, all in one transaction. If Alice utilizes a flash loan, then she can claim nearly all of the rewards for herself, leaving very little left for the legitimate stakers.
The fact that theNFTXVaultUpgradeablecontract contains a nativeflashLoanfunction makes this attack that much easier, although it would still be possible even without that due to flashloans on Uniswap, or wherever else the nftX token is found.
Since a flash loan will easily dwarf all of the legitimate stakers’ size of stake, the contract will erroneously award nearly all of the rewards to Alice.
Wait until an NFTX vault has accrued any significant amount of fees/rewardsFlashLoanBorrowa lot of ETH using any generic flash loan providerFlashLoanBorrowa lot of nftx-vault-token usingNFTXVaultUpgradeable.flashLoan()Deposit the ETH and nftx-vault-token’s into Uniswap for Uniswap LP tokens by callingUniswap.addLiquidity()Stake the Uniswap LP tokens inNFTXLPStakingby callingNFTXLPStaking.deposit()Claim nearly all of the rewards that have accrued for this vault due to how large the flashLoaned deposit is relative to all of the legitimate stakes by callingNFTXLPStaking.claimRewards()Remove LP tokens fromNFTXLPStakingby callingNFTXLPStaking.exit();Withdraw ETH and nftx-vault-token’s by callingUniswap.removeLiquidity();Pay back nftx-vault-token flash loanPay back ETH flash loan
SeeGitHub issue pagefor an in-depth  example.
Recommend requiring that staked LP tokens be staked for a particular period of time before they can be removed. Although a very short time frame (a few blocks) would avoid flash loan attacks, this attack could still be performed over the course of a few blocks less efficiently. Ideally, you would want the rewards to reflect the product of the amount staked and the duration that they’ve been staked, as well as having a minimum time staked.
Alternatively, if you really want to allow people to have the ability to remove their stake immediately, then only allow rewards to be claimed for stakes that have been staked for a certain period of time. Users would still be able to remove their LP tokens, but they could no longer siphon off rewards immediately.
0xKiwi (NFTX) disputed:
After looking at the code, this is not possible. The dividend token code takes into consideration the current unclaimed rewards and when a deposit is made that value is deducted.
cemozer (Judge) commented:
@0xKiwi do you mind showing where in code that occurs?