[H-02] Wrong returns ofSavingsAccountUtil.depositFromSavingsAccount()can cause fund loss
Submitted by WatchPug
The functionSavingsAccountUtil.depositFromSavingsAccount()is expected to return the number of equivalent shares for given_asset.
https://github.com/code-423n4/2021-12-sublime/blob/9df1b7c4247f8631647c7627a8da9bdc16db8b11/contracts/Pool/Pool.sol#L225-L267
/***@noticeinternal function used to get amount of collateral deposited to the pool*@param_fromSavingsAccountif true, collateral is transferred from _sender's savings account, if false, it is transferred from _sender's wallet*@param_toSavingsAccountif true, collateral is transferred to pool's savings account, if false, it is withdrawn from _sender's savings account*@param_assetaddress of the asset to be deposited*@param_amountamount of tokens to be deposited in the pool*@param_poolSavingsStrategyaddress of the saving strategy used for collateral deposit*@param_depositFromaddress which makes the deposit*@param_depositToaddress to which the tokens are deposited*@return_sharesReceived number of equivalent shares for given _asset*/function_deposit(bool_fromSavingsAccount,bool_toSavingsAccount,address_asset,uint256_amount,address_poolSavingsStrategy,address_depositFrom,address_depositTo)internalreturns(uint256_sharesReceived) {if(_fromSavingsAccount) {_sharesReceived=SavingsAccountUtil.depositFromSavingsAccount(ISavingsAccount(IPoolFactory(poolFactory).savingsAccount()),_depositFrom,_depositTo,_amount,_asset,_poolSavingsStrategy,true,_toSavingsAccount);}else{_sharesReceived=SavingsAccountUtil.directDeposit(ISavingsAccount(IPoolFactory(poolFactory).savingsAccount()),_depositFrom,_depositTo,_amount,_asset,_toSavingsAccount,_poolSavingsStrategy);}}
However, sincesavingsAccountTransfer()does not return the result of_savingsAccount.transfer(), but returned_amountinstead, which means thatSavingsAccountUtil.depositFromSavingsAccount()may not return the actual shares (when pps is not 1).
https://github.com/code-423n4/2021-12-sublime/blob/9df1b7c4247f8631647c7627a8da9bdc16db8b11/contracts/SavingsAccount/SavingsAccountUtil.sol#L11-L26
functiondepositFromSavingsAccount(ISavingsAccount_savingsAccount,address_from,address_to,uint256_amount,address_token,address_strategy,bool_withdrawShares,bool_toSavingsAccount)internalreturns(uint256) {if(_toSavingsAccount) {returnsavingsAccountTransfer(_savingsAccount,_from,_to,_amount,_token,_strategy);}else{returnwithdrawFromSavingsAccount(_savingsAccount,_from,_to,_amount,_token,_strategy,_withdrawShares);}}
https://github.com/code-423n4/2021-12-sublime/blob/9df1b7c4247f8631647c7627a8da9bdc16db8b11/contracts/SavingsAccount/SavingsAccountUtil.sol#L66-L80
functionsavingsAccountTransfer(ISavingsAccount_savingsAccount,address_from,address_to,uint256_amount,address_token,address_strategy)internalreturns(uint256) {if(_from==address(this)) {_savingsAccount.transfer(_amount,_token,_strategy,_to);}else{_savingsAccount.transferFrom(_amount,_token,_strategy,_from,_to);}return_amount;}
As a result, the recorded_sharesReceivedcan be wrong.
https://github.com/code-423n4/2021-12-sublime/blob/9df1b7c4247f8631647c7627a8da9bdc16db8b11/contracts/Pool/Pool.sol#L207-L223
function_depositCollateral(address_depositor,uint256_amount,bool_transferFromSavingsAccount)internalnonReentrant{uint256_sharesReceived=_deposit(_transferFromSavingsAccount,true,poolConstants.collateralAsset,_amount,poolConstants.poolSavingsStrategy,_depositor,address(this));poolVariables.baseLiquidityShares=poolVariables.baseLiquidityShares.add(_sharesReceived);emitCollateralAdded(_depositor,_amount,_sharesReceived);}
PoC
Given:
the price per share of yearn USDC vault is1.2Alice deposited12,000 USDCtoyearnstrategy, received10,000share tokens;Alice created a pool, and added all the12,000 USDCfrom the saving account as collateral; The recordedCollateralAddedgot the wrong number:12000which should be10000;Alice failed to borrow money with the pool and tries tocancelPool(), it fails as the recorded collateralsharesare more than the actual collateral.
As a result, Alice has lost all the12,000 USDC.
If Alice managed to borrow with the pool, when the loan defaults, the liquidation will also fail, and cause fund loss to the lenders.
Recommendation
Change to:
functionsavingsAccountTransfer(ISavingsAccount_savingsAccount,address_from,address_to,uint256_amount,address_token,address_strategy)internalreturns(uint256) {if(_from==address(this)) {return_savingsAccount.transfer(_amount,_token,_strategy,_to);}else{return_savingsAccount.transferFrom(_amount,_token,_strategy,_from,_to);}}
ritik99 (Sublime) confirmed