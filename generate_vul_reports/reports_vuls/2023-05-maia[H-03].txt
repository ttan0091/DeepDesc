[H-03]setWeight()Logic error
Submitted bybin2chen, also found byUdsen,BPZ, lukejohn (1,2), and ltyu (1,2,3)
Lines of code
https://github.com/code-423n4/2023-05-maia/blob/54a45beb1428d85999da3f721f923cbf36ee3d35/src/ulysses-amm/UlyssesPool.sol#L223
Proof of Concept
setWeight()is used to set the new weight. The code is as follows:
functionsetWeight(uint256poolId,uint8weight)externalnonReentrantonlyOwner{if(weight==0)revertInvalidWeight();uint256poolIndex=destinations[poolId];if(poolIndex==0)revertNotUlyssesLP();uint256oldRebalancingFee;for(uint256i=1;i<bandwidthStateList.length;i++) {uint256targetBandwidth=totalSupply.mulDiv(bandwidthStateList[i].weight,totalWeights);oldRebalancingFee+=_calculateRebalancingFee(bandwidthStateList[i].bandwidth,targetBandwidth,false);}uint256oldTotalWeights=totalWeights;uint256weightsWithoutPool=oldTotalWeights-bandwidthStateList[poolIndex].weight;uint256newTotalWeights=weightsWithoutPool+weight;totalWeights=newTotalWeights;if(totalWeights>MAX_TOTAL_WEIGHT||oldTotalWeights==newTotalWeights) {revertInvalidWeight();}uint256leftOverBandwidth;BandwidthStatestoragepoolState=bandwidthStateList[poolIndex];poolState.weight=weight;@>if(oldTotalWeights>newTotalWeights) {for(uint256i=1;i<bandwidthStateList.length;) {if(i!=poolIndex) {uint256oldBandwidth=bandwidthStateList[i].bandwidth;if(oldBandwidth>0) {bandwidthStateList[i].bandwidth=oldBandwidth.mulDivUp(oldTotalWeights,newTotalWeights).toUint248();leftOverBandwidth+=oldBandwidth-bandwidthStateList[i].bandwidth;}}unchecked{++i;}}poolState.bandwidth+=leftOverBandwidth.toUint248();}else{uint256oldBandwidth=poolState.bandwidth;if(oldBandwidth>0) {@>poolState.bandwidth=oldBandwidth.mulDivUp(oldTotalWeights,newTotalWeights).toUint248();leftOverBandwidth+=oldBandwidth-poolState.bandwidth;}for(uint256i=1;i<bandwidthStateList.length;) {if(i!=poolIndex) {if(i==bandwidthStateList.length-1) {@>bandwidthStateList[i].bandwidth+=leftOverBandwidth.toUint248();}elseif(leftOverBandwidth>0) {@>bandwidthStateList[i].bandwidth+=@>leftOverBandwidth.mulDiv(bandwidthStateList[i].weight,weightsWithoutPool).toUint248();}}unchecked{++i;}}}
There are several problems with the above code:
if (oldTotalWeights > newTotalWeights)should be changed toif (oldTotalWeights < newTotalWeights)because the logic inside of theifis to calculate the case of increasingweight.poolState.bandwidth = oldBandwidth.mulDivUp(oldTotalWeights , newTotalWeights).toUint248();should be modified topoolState.bandwidth = oldBandwidth.mulDivUp(newTotalWeights, oldTotalWeights).toUint248();because this calculates with the extra number.leftOverBandwidthhas a problem with the processing logic.
Recommended Mitigation Steps
functionsetWeight(uint256poolId,uint8weight)externalnonReentrantonlyOwner{...-if(oldTotalWeights>newTotalWeights) {+if(oldTotalWeights<newTotalWeights) {for(uint256i=1;i<bandwidthStateList.length;) {if(i!=poolIndex) {uint256oldBandwidth=bandwidthStateList[i].bandwidth;if(oldBandwidth>0) {bandwidthStateList[i].bandwidth=oldBandwidth.mulDivUp(oldTotalWeights,newTotalWeights).toUint248();leftOverBandwidth+=oldBandwidth-bandwidthStateList[i].bandwidth;}}unchecked{++i;}}poolState.bandwidth+=leftOverBandwidth.toUint248();}else{uint256oldBandwidth=poolState.bandwidth;if(oldBandwidth>0) {-poolState.bandwidth=oldBandwidth.mulDivUp(oldTotalWeights,newTotalWeights).toUint248();+poolState.bandwidth=oldBandwidth.mulDivUp(newTotalWeights,oldTotalWeights).toUint248();leftOverBandwidth+=oldBandwidth-poolState.bandwidth;}+uint256currentGiveWidth=0;+uint256currentGiveCount=0;for(uint256i=1;i<bandwidthStateList.length;) {+if(i!=poolIndex) {+if(currentGiveCount==bandwidthStateList.length-2-1) {//last+bandwidthStateList[i].bandwidth+=leftOverBandwidth-currentGiveWidth;+                    }+uint256sharesWidth=leftOverBandwidth.mulDiv(bandwidthStateList[i].weight,weightsWithoutPool).toUint248();+bandwidthStateList[i].bandwidth+=sharesWidth;+currentGiveWidth+=sharesWidth;+currentCount++;+                 }-if(i!=poolIndex) {-if(i==bandwidthStateList.length-1) {-bandwidthStateList[i].bandwidth+=leftOverBandwidth.toUint248();-                    }elseif(leftOverBandwidth>0) {-bandwidthStateList[i].bandwidth+=-leftOverBandwidth.mulDiv(bandwidthStateList[i].weight,weightsWithoutPool).toUint248();-                    }-               }unchecked{++i;}}}...
Assessed type
Context
0xLightt (Maia) confirmed
Trust (judge) increased the severity to High
0xLightt (Maia) commented:
We recognize the auditâ€™s findings on Ulysses AMM. These will not be rectified due to the upcoming migration of this section to Balancer Stable Pools.