[H-14] Fund lose in functionbringUnusedETHBackIntoGiantPool()ofGiantSavETHVaultPoolETH gets back to giant pool but the value of idleETH don’t increase
Submitted byunforgiven
https://github.com/code-423n4/2022-11-stakehouse/blob/4b6828e9c807f2f7c569e6d721ca1289f7cf7112/contracts/liquid-staking/GiantSavETHVaultPool.sol#L133-L157https://github.com/code-423n4/2022-11-stakehouse/blob/4b6828e9c807f2f7c569e6d721ca1289f7cf7112/contracts/liquid-staking/GiantPoolBase.sol#L24-L25
VariableidleETHin giant pools is storing total amount of ETH sat idle ready for either withdrawal or depositing into a liquid staking network and whenever a deposit or withdraw happens contract adjust the value ofidleETHof contract, but in functionbringUnusedETHBackIntoGiantPool()which brings unused ETH from savETH vault to giant pool the value ofidleETHdon’t get increased which would cause those ETH balance to not be accessible for future staking or withdrawing.
Proof of Concept
This isbringUnusedETHBackIntoGiantPool()code inGiantSavETHVaultPool():
/// @notice Any ETH that has not been utilized by a savETH vault can be brought back into the giant pool/// @param _savETHVaults List of savETH vaults where ETH is staked/// @param _lpTokens List of LP tokens that the giant pool holds which represents ETH in a savETH vault/// @param _amounts Amounts of LP within the giant pool being burntfunction bringUnusedETHBackIntoGiantPool(address[] calldata _savETHVaults,LPToken[][] calldata _lpTokens,uint256[][] calldata _amounts) external {uint256 numOfVaults = _savETHVaults.length;require(numOfVaults > 0, "Empty arrays");require(numOfVaults == _lpTokens.length, "Inconsistent arrays");require(numOfVaults == _amounts.length, "Inconsistent arrays");for (uint256 i; i < numOfVaults; ++i) {SavETHVault vault = SavETHVault(_savETHVaults[i]);for (uint256 j; j < _lpTokens[i].length; ++j) {require(vault.isDETHReadyForWithdrawal(address(_lpTokens[i][j])) == false,"ETH is either staked or derivatives minted");}vault.burnLPTokens(_lpTokens[i], _amounts[i]);}}
As you can see it checks that ETH is available in savETH vault and then calls toburnLPTokens()to burn savETH LP tokens and bring unused ETH to giant pool address, this would increase giant pool ETH balance but code don’t increase theidleETHvalue so contract would lose tracking of real idle ETH balance of contract. because the vaule ofidleETHis used when withdrawing or depositing into savETH vaults so the contract can’t reuse the returned ETH. these are the steps that cause this bug to happen:
giant pool has 100idleETH.with functionbatchDepositETHForStaking()users stake 80ETHand the new value ofidleETHwould be20and contract LP Token balance increase by 80.the 80 newly staked ETH is not yet staked instakehouse.with functionbringUnusedETHBackIntoGiantPool()users bring back those 80ETHfrom Vaults to giant pool and burn giant pool LP tokens and then giant pool have 100 idle ETH but becauseidleETHvalue don’t get increase it still would show20.the extra 80 ETH would returned to giant pool wouldn’t be accessible for withdrawing to users or depositing into Vaults because in withdrawing or depositing into Vaults the value ofidleETHhas been used to know the amount of idle ETH in giant pool and because the value doesn’t show the correct amount so the extra amount of ETH wouldn’t be lost.
Tools Used
VIM
Recommended Mitigation Steps
Contract should correctly update value ofidleETHin different actions because withdraw and deposit logics depend on it.
vince0656 (Stakehouse) confirmed